function inizio(){aggiusta();var o=document.getElementById("Fx");o.value="";o.focus();risp=Array();Simb=Array();f=Array();sist=Array();eq="";ing="";}function toglispazi(x){var i=x.indexOf(" ");while(i!=-1){x=x.substr(0,i)+x.substr(i+1);i=x.indexOf(" ");}return(x);}function Completa(){risp=Array();Simb=Array();f=Array();sist=Array();eq="";ing="";var b;var n=0;reac=toglispazi(document.getElementById("Fx").value);var i=reac.indexOf("=");if(i==-1){i=reac.indexOf(">");}if(i==-1){alert("La reazione non e' completa");document.getElementById("Fx").focus();}else{var prima=reac.substr(0,i);var dopo=reac.substr(i+1);}while(prima!=""){i=prima.indexOf("+");if(i==-1){ing=prima;prima="";}else{if(prima.charAt(i+1)=="+"){i++;}ing=prima.substr(0,i);prima=prima.substr(i+1);}b=new Formula(ing);if(b.serror){alert("errore di sintassi");return;}else{f[n]=b;n++;}}f[n]=">";n++;while(dopo!=""){i=dopo.indexOf("+");if(i==-1){ing=dopo;dopo="";}else{if(dopo.charAt(i+1)=="+"){i++;}ing=dopo.substr(0,i);dopo=dopo.substr(i+1);}b=new Formula(ing);if(b.serror){alert("errore di sintassi"); return;}else{f[n]=b;n++;}}var ris=bilancia();if(ris==0){ek="";piu=false;k=0;for(var i=0;i<f.length;i++){if(f[i]==">"){ek+=" &rarr; ";piu=false;}else{if(piu){ek+=" + ";}if(risp[k]!=1){ek+=risp[k]+" ";}ek+=f[i].at.HTML;piu=true;k++;}}document.getElementById("risultato").innerHTML+="<br>"+ek;}else{switch(ris){case 1: alert("equazione indeterminata");break;}alert("La reazione non pu√≤ essere bilanciata");document.getElementById("Fx").focus();}}function bilancia(){var k=0;var simbsgn=1;for(var i=0;i<f.length;i++){var s=f[i];if(s!=">"){for(var k=0;k<f[i].at.s.length;k++){var s1=f[i].at.s[k];if(Simb[s1]==null){Simb[s1]=simbsgn;}else{Simb[s1]=0;}}}else{simbsgn=2;}}var ersimb=false;var msg1="";var msg2="";
for(x in Simb){if(Simb[x]==1){if(msg1==""){msg1+="Alcuni elementi dei reagenti mancano nei prodotti:"}msg1+=" "+x;ersimb=true;}if(Simb[x]==2){if(msg2==""){msg2+="Alcuni elementi dei prodotti mancano nei reagenti:"}msg2+=" "+x;ersimb=true;}}if(ersimb){alert(msg1+" "+msg2);return(3);}var r=0;sgn=1;c=0;sist[r]=new Array();for(i=0;i<f.length;i++){s=f[i];if(s==">"){sgn=-1;}else{sist[r][c]=s.at.carica*sgn;c++;}}var r=1;for(xx1 in Simb){sist[r]=new Array();sgn=1;c=0;for(i=0;i<f.length;i++){s=f[i];if(s==">"){sgn=-1;}else{if(s.at.v[xx1]==null){sist[r][c]=0;}else{sist[r][c]=s.at.v[xx1]*sgn;}c++;}}r++;}return(elabora());}function scambia(x,y){var p=Array();p=sist[x];sist[x]=sist[y];sist[y]=p}function azzera(x,y){var a=sist[x][y];if(a!=0){var b=sist[y][y];var c=mcm(a,b);for(var i=y;i<sist[x].length;i++){sist[x][i]=sist[x][i]*c/a-sist[y][i]*c/b;}}}function elabora(){var m0=sist.length;var n0=sist[0].length;if(m0<n0-1){return(1)}var mcd=MCDArr(sist[0]);if(mcd==0){scambia(0,m0-1);m0--;}var l0=sist[0].length-1;if(mcd>1){dividi(sist[0],mcd);}for(var i=0;i<l0;i++){r=i;while((sist[r][i]==0)&&(r<sist.length-1)){r++;}if(r!=i){scambia(i,r);}if(sist[i][i]==0){return(1);}for(var k=i+1;k<sist.length;k++){azzera(k,i);if(mcd>1){dividi(sist[k],mcd);}}}risp[l0]=1;for(i=l0-1;i>=0;i--){var a=sist[i][i];if(a<0){moltiplica(sist[i],-1);a=-a;}var cont=0;for(j=i+1;j<=l0;j++){cont-=sist[i][j]*risp[j];}mcd=MCD(a,cont);a=a/mcd;cont=cont/mcd;if(a!=1){moltiplica(risp,a);}risp[i]=cont;}if(sist.length>sist[0].length){mcd=MCDArr(sist[l0]);if(mcd!=0){return(-1);}}return(0);}function MCDArr(x){var i=0;while((x[i]==0)&&(i<x.length)){i++;}if(i==x.length){return(0);}else{r=x[i];for(var j=i+1;j<x.length;j++){if(x[j]!=0){r=MCD(r,x[j]);}}return(r);}}function dividi(x,a){for(var i=0;i<x.length;i++){x[i]=x[i]/a;}}function moltiplica(x,a){for(var i=0;i<x.length;i++){x[i]=x[i]*a;}}function MCD(a,b){if(a<0){a=-a;}if(b<0){b=-b;}var resto=b;if(b>a){resto=a;a=b;b=resto;}while(resto>0){if(resto==1){return(1);resto=0;}else{resto=a%b;a=b;if(resto==0){return(b);}b=resto;}}}function mcm(a,b){return(a*b)/MCD(a,b);}
